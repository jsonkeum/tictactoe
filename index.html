<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <title>Tic Tac Toe</title>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Poppins');
        html {
          height:100%;
        }
        body {
            font-family:'Poppins';
            height:100%;
            background:black;
            color:white;
        }
        #message {
          margin-top:50px;
        }
        #dividers {
          margin-top:75px;
          height:600px;
          width:600px;
          padding: 0px;
          background: linear-gradient(-45deg, #33beff, #ff4d4d);
        }
        table {
          height:600px;
          width:600px;
        }
        tr {
          height:200px;
          width:100%;
          padding:0px;
        }
        td {
          height:200px;
          width:200px;
          background:black;
          display:inline-block;
          border:5px solid transparent;
          background-clip:padding-box;
        }
        #rowZero td {
          border-top:0px;
        }
        tr > td:first-child{
          border-left:0px;
        }
        #rowTwo td {
          border-bottom:0px;
        }
        tr > td:last-child {
          border-right:0px;
        }
        .circle {
          opacity: 0;
        }
        .blue {
          width:90%;
          height:90%;
          background:linear-gradient(45deg, #ccf2ff ,#007399);
          border-radius:50%;
          margin:auto;
          margin-top:10px;
        }
        .red {
          width:90%;
          height:90%;
          background:linear-gradient(45deg, #ffcccc, #990000);
          border-radius:50%;
          margin:auto;
          margin-top:10px;
        }
        .inner {
          background:black;
          border-radius:50%;
          width:100%;
          height:100%;
          border:10px solid transparent;
          background-clip:padding-box;
        }
        #choose {
          margin-top:100px;
          height:300px;
          width:600px;
          margin-left:auto;
          margin-right:auto;
        }
        .choice {
          height:300px;
          width:300px;
          cursor:pointer;
          display:inline-block;
        }
        #blue, #red {
          opacity:1;
        }
        #signature {
          margin-top:100px;
        }
    </style>
</head>
<body>
<h2 id="message" class="text-center"></h2>
<!-- 
    Start of JS
-->
<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script>
var initialize = false;
var userColor = "";
var cpuColor = "";
var yourTurn = false;
var firstMove = false;
var board = [];
var cpuVictory = false;
var rowKey = ["zero", "one", "two", "three", "four", "five", "six", "seven", "eight"];
var victory = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
var sides = [1,3,5,7];
var corners = [0,2,6,8];
var cornerPairs = [[0,8],[2,6]];
var boardStart = ["Def", "Def", "Def", "Def", "Def", "Def", "Def", "Def", "Def"];
var timeoutID;
var timeoutIDTwo;


// Function to handle message changes.
var changeMessage = function(message){
  $("#message").animate({opacity: 0}, 250, function(){
      $("#message").text(message);
      $("#message").animate({opacity: 1}, 250);
  });
}

//Loads the choose color option onto the DOM
var setColor = function(){
  changeMessage("choose a color");
  $("body").append('<div id="choose"><div class="choice"><div class="circle blue" id="blue"></div></div><div class="choice"><div class="circle red" id="red"></div></div></div><p class="text-center" id="signature"><em>Tic Tac Toe</em> - written by QuanchiFootball</p>');
  $("#choose").hide().fadeIn(1000);
  $("#signature").hide().fadeIn(1000);
}

//Handles user color choice
var sidePicker = function(side){
  if(side == "red"){
    userColor = side;
    cpuColor = "blue";
  } else if (side == "blue"){
    userColor = side;
    cpuColor = "red";
  }
  initialize = true;
  loadBoard();
}
//Loads the game board
var loadBoard = function(){
  $("#choose").remove();
  $("#signature").remove();
  $("body").append('<div class="container" id="dividers"><table><tr id="rowZero"><td id="zero"></td><td id="one"></td><td id="two"></td></tr><tr id="rowOne"><td id="three"></td><td id="four"></td><td id="five"></td></tr><tr id="rowTwo"><td id="six"></td><td id="seven"></td><td id="eight"></td></tr></table></div>');
  $("#dividers").hide().fadeIn(1000);
  board = boardStart.slice();
  whoStarts();
}
//Flips a coin to determine who goes first.
var whoStarts = function(){
  yourTurn = (Math.round(Math.random()) == 1 ? true : true);
  if(yourTurn){
    changeMessage("your turn");
  } else {
    firstMove = true;
    timeoutID = window.setTimeout(cpuTurn, 1000);
  }
}
//sets the marker down on the chosen square
var drawCircle = function(numberString, color){
  console.log("PLACING MARKER ON SQUARE " + numberString);
  $("#"+numberString).html('<div class="circle '+color+'"><div class="inner"></div></div>');
  $("#"+numberString + "> .circle").animate({opacity:1},500);
}
//Handles user turn sequence
var addMarker = function(spot){
  if(board[rowKey.indexOf(spot)] == "Def"){
    board[rowKey.indexOf(spot)] = "User";
  } else {
    return;
  }
  console.log("------------------ USER TURN ------------------");
  drawCircle(spot, userColor);
  timeoutID = window.setTimeout(gameOver, 500);
}
//Handles CPU turn sequence
var cpuTurn = function(){
  console.log("------------------ CPU TURN ------------------");
  changeMessage("cpu turn");
  timeoutIDTwo = window.setTimeout(cpuTurnLogic, 600);
  timeoutID = window.setTimeout(gameOver, 1200);
  
}

var flash = function(playerString){
  victory.forEach(function(arr){
    var count = 0;
    arr.forEach(function(key){
      if(board[key]==playerString){
        count++;
      }
    });
    if(count == 3){
      $("#"+rowKey[arr[0]] + "> .circle").addClass("animated flash");
      $("#"+rowKey[arr[1]] + "> .circle").addClass("animated flash");
      $("#"+rowKey[arr[2]] + "> .circle").addClass("animated flash");
    }
  });
}

//Check whether user has won
var hasUserWon = function(){
  for(var i = 0; i<victory.length;i++){
    var count = 0;
    var arr = victory[i];
    for(var j = 0; j < arr.length; j++){
      if(arr[j] == "User"){
        count++
      }
    };
    if(count == 3){
      return true;
    }
  }
  return false;
}

//Check if the game will end in a draw.
var gameDraw = function(){
  if(!board.includes("Def")){
    return true;
  }
  return false;
}

//Handles game over sequence
var gameOver = function(){
  if(cpuVictory){
    changeMessage("sorry, cpu wins");
    flash("CPU");
    resetter();
    return;
  }
  if(hasUserWon()){
    changeMessage("congrats, you win");
    flash("User");
    resetter();
    return;
  }
  if(gameDraw()){
    changeMessage("it's a draw");
    resetter();
    return;
  }
  if(yourTurn){
    yourTurn = false;
    cpuTurn();
  } else {
    yourTurn = true;
    changeMessage("your turn");
  }
}

var resetter = function(){
  timeoutID = window.setTimeout(wiper, 3000);
}

var wiper = function(){
  initialize = false;
  userColor = "";
  cpuColor = "";
  yourTurn = false;
  firstMove = false;
  board = [];
  cpuVictory = false;
  $("#dividers").animate({opacity:0}, 500, function(){
    $("#dividers").remove();
    changeMessage("choose a color");
    setColor();
  });
}

//CPU TURN LOGIC BEGIN

var winOrBlock = function(spaceString){
  console.log("init winOrBlock");
  var count = 0;
  var def = 0;
  for(var i = 0; i < victory.length; i++){
    var arr = victory[i];
    var defKey = null;
    for(var j = 0; j<arr.length;j++){
      var key = arr[j];
      if(board[key] == spaceString){
        count++;
      } else if(board[key] == "Def") {
        def++;
        defKey = key;
      }
    };
    if(count == 2 && def == 1){
      board[defKey] = "CPU";
      drawCircle(rowKey[defKey], cpuColor);
      console.log("winOrBlock trig");
      return true;
    }
    count = 0;
    def = 0;
  };
  console.log("winOrBlock false");
  return false;
}

var forkMove = function(){
  console.log("init forkMove");
  for(var i = 0; i<board.length; i++){
    if(board[i] == "Def"){
      board[i] = "CPU";
      if(forkCheckBoolean("CPU")){
        console.log("forkMove trig");
        drawCircle(rowKey[i], cpuColor);
        return true;
      } else {
        board[i] = "Def";
      }
    }
  };
  console.log("forkMove false");
  return false;
}

var forkCheckBoolean = function(spotString){
  var count = 0;
  var def = 0;
  var opp = 0;
  victory.forEach(function(arr){
    arr.forEach(function(key){
      if(board[key] == spotString){
        count++;
      } else if(board[key] == "Def") {
        def++;
      }
    });
    if(count == 2 && def == 1){
      opp++;
    }
    count = 0;
    def = 0;
  });
  if(opp == 2){
    return true;
  } else {
    return false;
  }
}

var blockUserFork = function(){
  console.log("init blockUserFork");
  for(var i = 0; i<board.length; i++){
    var userCorners = 0;
    if(board[i] == "Def"){
      board[i] = "User";
      if(forkCheckBoolean("User")){
        board[i] = "Def";
        corners.forEach(function(key){
          if(board[key] == "User"){
            userCorners++;
          }
        });
        if(userCorners == 2){
          console.log("blockUserFork trig strat 1");
          return empty(sides);
        } else {
          
          console.log("blockUserFork trig strat 2");
          
          return empty(corners);
        }
      } else {
        board[i] = "Def";
      }
    }
  }
  console.log("blockUserFork false");
  return false;
}

var makeFirstMove = function(){
  console.log("init firstMove");
  if(!firstMove){
     console.log("firstMove false");
     return false;
  }
  firstMove = false;
  var coin = Math.round(Math.random());
  if(coin === 0){
    console.log("firstMove trig center");
    return centerMove();
  } else {
    var randomCorner = corners[Math.floor(Math.random()*corners.length)];
    board[randomCorner] = "CPU";
    console.log("firstMove trig corner");
    drawCircle(rowKey[randomCorner], cpuColor);
    return true;
  }
}

var centerMove = function(){
  console.log("init centerMove")
  if(board[4] == "Def"){
    board[4] = "CPU";
    console.log("centerMove trig");
    drawCircle(rowKey[4], cpuColor);
    return true;
  } else {
    console.log("centerMove false");
    return false;
  }
}

var cornerCheck = function(){
  console.log("init cornerCheck");
  for(var i = 0; i < cornerPairs.length; i++){
    var user = null;
    var def = null;
    for(var j = 0;j< cornerPairs[i].length;j++){
      var key = cornerPairs[i][j];
      if(board[key] == "User"){
        user = key;
      } else if(board[key] == "Def"){
        def = key;
      }
    }
    if(user != null && def != null){
      board[def] = "CPU";
      console.log("cornerCheck trig");
      drawCircle(rowKey[def], cpuColor);
      return true;
    }
  }
  console.log("cornerCheck false");
  return false;
}

var empty = function(array){
  console.log("init empty");
  var emptySpaces = [];
  for(var i = 0; i<array.length;i++){
    var key = array[i]
    if(board[key] == "Def"){
      emptySpaces.push(key);
    }
  };
  if(emptySpaces.length > 0){
    var random = emptySpaces[Math.floor(Math.random()*emptySpaces.length)];
    board[random] = "CPU";
    console.log("empty trig");
    drawCircle(rowKey[random], cpuColor);
    return true;
  }
  console.log("empty false");
  return false;
}

var cpuTurnLogic = function(){
  //WINNING MOVE
  var winGame = winOrBlock("CPU");
  if(winGame){
    cpuVictory = true;
    return true;
  }
  //BLOCK USER FROM WINNING
  var blockUser = winOrBlock("User");
  if(blockUser){
    return true;
  }
  //CREATE TWO ROWS WITH TWO MARKERS
  var tryForkMove = forkMove();
  if(tryForkMove){
    return true;
  }
  //BLOCK OPPONENT FROM FORKING
  var tryForkBlock = blockUserFork();
  if(tryForkBlock){
    return true;
  }
  // FIRST MOVE either corner or center
  if(makeFirstMove()){
    return true;
  };
  // CENTER
  var tryCenter = centerMove();
  if(tryCenter){
    return true;
  }
  // OPPOSITE CORNER
  var tryCornerCheck = cornerCheck();
  if(tryCornerCheck){
    return true;
  }
  // EMPTY CORNER
  console.log("init empty corners");
  var tryEmptyCorner = empty(corners);
  if(tryEmptyCorner){
    return true;
  }
  // EMPTY SIDE
  console.log("init empty sides");
  var tryEmptySide = empty(sides);
  if(tryEmptySide){
    return true;
  }
}

//CPU TURN STUFF END

$(document).ready(function(){
  setColor(); 
  $(document).on("click", ".circle", function(){
    if(!initialize){
      sidePicker($(this).attr('id'));
    }
  });
  
  $(document).on("click", "td", function(){
    if(yourTurn){
      addMarker($(this).attr('id'));
    }
  });
});
</script>
</body>
</html>